{% load static %}
<meta http-equiv="refresh" content="300">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<h1>team_management</h1>
<h2>רשימת המשימות שלי</h2>


<div style="background-color: #f9f9f9; padding: 10px; border: 1px solid #ccc;">
    <h4>חיפוש במשימות של הקבוצה</h4>
    <h6>לפי סטטוס:</h6>

    <p>
<h6>לפי סטטוס:</h6>
<p>
    <a href="{% url 'get_tasks' %}" class="btn {% if not current_filter %}btn-dark{% else %}btn-outline-dark{% endif %} btn-sm">הכל</a>
    <a href="?status=NEW_TASK" class="btn {% if current_filter == 'NEW' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">משימות לא משויכות</a>
    <a href="?status=ON_PROCESS" class="btn {% if current_filter == 'ON_PROCESS' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">משימות בתהליך</a>
    <a href="?status=DONE" class="btn {% if current_filter == 'DONE' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">משימות שבוצעו</a>
    <a href="?status=EXPIRED" class="btn {% if current_filter == 'EXPIRED' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">משימות שלא נעשו</a>
</p>
    </p>
    {% if user.role == "Manager" %}
    <h4>פעולות ניהול:</h4>
    <a href="{% url 'add_task' %}" class="btn">הוספת משימה חדשה</a>
    {% endif %}
</div>


<h4>{{ team.team_name }}</h4>
<table border="1" style="width:100%; border-collapse: collapse; text-align: right;">
    <thead>
    <tr>
        <th>שם המשימה</th>
        <th>תיאור</th>
        <th>תאריך יעד</th>
        <th>סטטוס המשימה</th>
        <th>מבצע המשימה</th>
        {% if user.role == "Manager" %}
        <th>פעולות</th>
        {% endif %}
    </tr>
    </thead>
    <tbody>
    {% for task in tasks %}
    <tr>
        <td>{{ task.name }}</td>
        <td>{{ task.description }}</td>
        <td>{{ task.end_date }}</td>
        <td>{{ task.get_status_display }}
        {% if  user.id == task.owner.id and task.status != 'DONE' %}
        <form action="{% url 'update_status' task.id %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <button type="submit" class="btn btn-primary btn-sm">עדכן סטטוס
                </button>
            </form>
        </td>
        {% endif %}
        {% if user.role == "Manager" and not task.owner.email %}
        <td>
            <form action="{% url 'update_owner' task.id %}" method="POST" id="form-{{ task.id }}">
                {% csrf_token %}
                <select name="user_id" class="form-select form-select-sm" style="width: auto;"
                        onchange="this.form.submit()">
                    <option value="">-- בחר עובד --</option>
                    {% for member in users %}
                    <option value="{{ member.id }}" {% if task.owner == member %} selected {% endif %}>
                        {{ member.first_name }} {{ member.last_name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </td>
        {% elif not task.owner.email %}
        <td>
            <form action="{% url 'update_owner' task.id %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <button type="submit" class="btn btn-primary btn-sm">
                    שייך אלי
                </button>
            </form>
        </td>
        {% else %}
        <td>{{ task.owner.first_name }} {{ task.owner.last_name }}</td>
        {% endif %}
        {% if user.role == "Manager" %}
        <td>
            <div style="display: flex; gap: 5px;">
                <form action="{% url 'delete_task' task.id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('האם למחוק?')">
                        מחיקה
                    </button>
                </form>
                {% if user.role == "Manager" and not task.owner.email %}
                <a href="{% url 'edit_task' task.id %}" class="btn btn-warning btn-sm">ערוך</a>
                {% endif %}
            </div>
        </td>
        {% endif %}
    </tr>
    {% empty %}
    <tr>
        <td colspan="6" style="text-align:center;">אין משימות להצגה לצוות זה</td>
    </tr>
    {% endfor %}
    </tbody>
</table>